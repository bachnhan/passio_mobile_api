
<div id="dashBoard" style="margin-top: 10px">

    <div class="page-header">
        <div class="row">
            <div class="col-md-6 col-xs-12">
                <h1 id="date"></h1>
            </div>
            <div class="col-lg-5 col-lg-offset-1 col-md-5 col-md-offset-1 col-xs-12">
                <div class="input-group">

                    <div class="date-picker" id="reportrange">
                        <input type="text" id="date-string" />
                        <a id="reportrange"><i class="fa fa-calendar"></i></a>
                    </div><!-- /input-group -->

                    <div class="input-group-btn">
                        <a class="btn btn-success" id="btnSearch" style="margin-top: 3px">
                            <i class="left-icon fa fa-search"></i>Xem báo cáo
                        </a>
                    </div>
                    <input type="hidden" id="startDate" />
                    <input type="hidden" id="endDate" />
                </div><!-- /input-group -->
            </div>
        </div>
    </div>

    <div class="row" style="margin-top: 10px">
        <div class="col-lg-4 col-xs-6">
            <div class="info-box">
                <span class="info-box-icon bg-green"><i class="ion ion-cash"></i></span>
                <div class="info-box-content">
                    <span class="info-box-text">Tổng doanh thu</span>
                    <span class="info-box-number"><span id="tongDoanhThu"></span> <small>VND</small></span>
                    <div id="avgTotalAmount">
                        <span style="font-size:14px">Trung bình</span> <strong style="font-size:16px"></strong> <span style="font-size:12px"><b> VND/ngày</b></span>
                    </div>
                </div><!-- /.info-box-content -->
            </div><!-- /.info-box -->
        </div>
        <div class="col-lg-4 col-xs-6">
            <div class="info-box">
                <span class="info-box-icon bg-aqua">
                    <i class="ino ion-pricetag"></i>
                </span>
                <div class="info-box-content">
                    <span class="info-box-text">Tổng giảm giá</span>
                    <span class="info-box-number"><span id="tongGiamGia"></span> <small>VND</small></span>
                    <div id="avgTotalDiscount">
                        <span style="font-size:14px">Trung bình</span> <strong style="font-size:16px"></strong> <span style="font-size:12px"><b> VND/ngày</b></span>
                    </div>
                </div><!-- /.info-box-content -->
            </div><!-- /.info-box -->
        </div>
        <div class="col-lg-4 col-xs-6">
            <div class="info-box">
                <span class="info-box-icon bg-red">
                    <i class="ion ion-social-usd"></i>
                </span>
                <div class="info-box-content">
                    <span class="info-box-text">Doanh thu sau giảm giá</span>
                    <span class="info-box-number"><span id="sauGiamGia"></span> <small>VND</small></span>
                    <div id="avgFinalAmount">
                        <span style="font-size:14px">Trung bình</span> <strong style="font-size:16px"></strong> <span style="font-size:12px"><b> VND/ngày</b></span>
                    </div>
                </div><!-- /.info-box-content -->
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-6 col-md-6 col-sm-6 col-xs-12">
            <!-- Tổng thu -->
            <div class="box box-danger">
                <div class="box-header with-border">
                    <h3 class="box-title">Tổng thu <strong id="tongThu"></strong><strong><small> VND</small></strong></h3>
                    <div class="box-tools pull-right">
                        <button class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i></button>
                    </div>
                </div>

                <!-- Tiền mặt -->
                <div class="box-body" style="margin-top: 9px">
                    <div class="info-box bg-red">
                        <span class="info-box-icon"><i class="ion ion-cash"></i></span>
                        <div class="info-box-content">
                            <span class="info-box-text">Tiền mặt</span>
                            <span class="info-box-number">
                                <span id="tienMat"></span><strong><small> VND</small></strong>
                            </span>
                            <div class="progress">
                                <div class="progress-bar" id="tienMatPB"></div>
                            </div>
                            <span class="progress-description">
                                Chiếm <span id="phanTramTienMat"></span>
                            </span>
                        </div><!-- /.info-box-content -->
                    </div><!-- /.info-box -->
                    <!-- Thẻ thành viên -->
                    <div class="info-box bg-green">
                        <span class="info-box-icon"><i class="ion ion-person"></i></span>
                        <div class="info-box-content">
                            <span class="info-box-text">Thẻ thành viên</span>
                            <span class="info-box-number">
                                <span id="theThanhVien"></span><strong><small> VND</small></strong>
                            </span>
                            <div class="progress">
                                <div class="progress-bar" id="theThanhVienPB"></div>
                            </div>
                            <span class="progress-description">
                                Chiếm <span id="phanTramTheThanhVien"></span>
                            </span>
                        </div><!-- /.info-box-content -->
                    </div><!-- /.info-box -->
                    <!-- Thẻ tín dụng -->
                    <div class="info-box bg-yellow">
                        <span class="info-box-icon"><i class="ion ion-card"></i></span>
                        <div class="info-box-content">
                            <span class="info-box-text">Thẻ tín dụng</span>
                            <span class="info-box-number">
                                <span id="theTinDung"></span><strong><small> VND</small></strong>
                            </span>
                            <div class="progress">
                                <div class="progress-bar" id="theTinDungPB"></div>
                            </div>
                            <span class="progress-description">
                                Chiếm <span id="phanTramTheTinDung"></span>
                            </span>
                        </div><!-- /.info-box-content -->
                    </div><!-- /.info-box -->
                </div><!-- /.box-body -->
            </div><!-- /.box -->
        </div>
        <div class="col-lg-6 col-md-6 col-sm-6 col-xs-12">
            <!-- Tổng Hoá Đơn Chart -->
            <div class="box box-info">
                <div class="box-header with-border">
                    <h3 class="box-title">Tổng hoá đơn <strong id="tongHoaDoa"></strong></h3>
                    <div class="box-tools pull-right">
                        <button class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i></button>
                    </div>
                </div>
                <div class="box-body">
                    <canvas id="pieChart" style="height:250px"></canvas>
                </div><!-- /.box-body -->
                <div class="box-footer no-padding">
                    <div class="row">
                        <div class="col-lg-4 col-md-4 col-sm-4 col-xs-12 text-center border-right">
                            <div style="width:70%;height:5px;background-color:#f56954;margin:0 auto"></div>
                            <span style="font-size: 14px">AtStore</span> <br />
                            <strong id="atStore" style="font-size: 14px"></strong>
                        </div>
                        <div class="col-lg-4 col-md-4 col-sm-4 col-xs-12 text-center border-right">
                            <div style="width:70%;height:5px;background-color:#00a65a;margin:0 auto"></div>
                            <span style="font-size: 14px">TakeAway</span> <br />
                            <strong id="takeAway" style="font-size: 14px"></strong>
                        </div>
                        <div class="col-lg-4 col-md-4 col-sm-4 col-xs-12 text-center">
                            <div style="width:70%;height:5px;background-color:#f39c12;margin:0 auto"></div>
                            <span style="font-size: 14px">Delivery</span> <br />
                            <strong id="delivery" style="font-size: 14px"></strong>
                        </div>
                    </div>
                </div>
            </div><!-- /.box -->
        </div>
    </div>

    <div class="row" id="tongThuChart">
        <div class="box box-danger">
            <div class="box-header with-border">
                <h3 class="box-title">Tổng thu qua các ngày</h3>
                <div class="box-tools pull-right">
                    <button class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i></button>
                </div>
            </div>
            <div class="box-body">
                <canvas id="lineChart" style="width:100%;height:300px"></canvas>
            </div><!-- /.box-body -->
        </div><!-- /.box -->
    </div>
</div>

<script>
    function numberWithDot(x) {
        return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    };

    $('#btnSearch').click(function () {
        $('#date').text('');
        if ($('#date-string').val().toString().indexOf('/') > 0) {
            $('#date').append('Tổng quan ngày ' + $('#date-string').val());
        } else {
            $('#date').append('Tổng quan ' + $('#date-string').val().toString().toLowerCase());
        }

        getData($('#startDate').val(), $('#endDate').val());
    });

    function getData(startDate, endDate) {
        $.ajax({
            url: '@Url.Action("DateData")',
            type: 'GET',
            data: { storeId: '@ViewBag.storeId', _startDate: startDate, _endDate: endDate },
            success: function (rs) {
                if (rs.success) {
                    //Doanh thu
                    discountRevenue = rs.discountRevenue
                    $('#tongDoanhThu').text('');
                    $('#tongGiamGia').text('');
                    $('#sauGiamGia').text('');
                    $('#tongDoanhThu').append(numberWithDot(discountRevenue.totalAmount));
                    $('#tongGiamGia').append(numberWithDot(discountRevenue.totalDiscount));
                    $('#sauGiamGia').append(numberWithDot(discountRevenue.finalAmount));

                    //Hoá đơn
                    receipt = rs.receipt;
                    $('#tongHoaDoa').text('');
                    $('#atStore').text('');
                    $('#takeAway').text('');
                    $('#delivery').text('');
                    $('#tongHoaDoa').append(numberWithDot(receipt.totalReceipt));
                    $('#atStore').append(numberWithDot(receipt.qtyAtStore));
                    $('#takeAway').append(numberWithDot(receipt.qtyDelivery));
                    $('#delivery').append(numberWithDot(receipt.qtyTakeAway));
                    tongHoaDonChart(receipt.recepitQty);

                    //Hình thúc thanh toán
                    //dataPayment = rs.dataPayment;
                    //$('#tongThu').text('');
                    //$('#tienMat').text('');
                    //$('#theThanhVien').text('');
                    //$('#theTinDung').text('');
                    //$('#tongThu').append(numberWithDot(dataPayment.payment));
                    //$('#tienMat').append(numberWithDot(dataPayment.paymentCash));
                    //$('#theThanhVien').append(numberWithDot(dataPayment.paymentUserCard));
                    //$('#theTinDung').append(numberWithDot(dataPayment.paymentCreditCard));
                    //if (dataPayment.totalPaymentList.length > 1) {
                    //    $('#avgTotalAmount').show();
                    //    $('#avgTotalAmount strong').text('');
                    //    $('#avgTotalAmount strong').append(numberWithDot((dataAmount.totalAmount / dataPayment.totalPaymentList.length).toFixed(0)))

                    //    $('#avgTotalDiscount').show();
                    //    $('#avgTotalDiscount strong').text('');
                    //    $('#avgTotalDiscount strong').append(numberWithDot((dataAmount.totalDiscount / dataPayment.totalPaymentList.length).toFixed(0)))

                    //    $('#avgFinalAmount').show();
                    //    $('#avgFinalAmount strong').text('');
                    //    $('#avgFinalAmount strong').append(numberWithDot((dataAmount.finalAmount / dataPayment.totalPaymentList.length).toFixed(0)))
                    //} else {
                    //    $('#avgTotalAmount').hide();
                    //    $('avgTotalDiscount').hide();
                    //    $('avgFinalAmount').hide();
                    //}

                    //Phần trăm các hình thức
                    //var cashPercentage = 0
                    //var userCardPercentage = 0
                    //var creditCardPercentage = 0
                    //if (dataPayment.payment > 0) {
                    //    cashPercentage = (dataPayment.paymentCash / dataPayment.payment) * 100;
                    //    userCardPercentage = (dataPayment.paymentUserCard / dataPayment.payment) * 100;
                    //    creditCardPercentage = (dataPayment.paymentCreditCard / dataPayment.payment) * 100;
                    //}

                    //$('#phanTramTienMat').text('');
                    //$('#phanTramTheThanhVien').text('');
                    //$('#phanTramTheTinDung').text('');
                    //$('#phanTramTienMat').append(cashPercentage.toFixed(2) + '%');
                    //$('#phanTramTheThanhVien').append(userCardPercentage.toFixed(2) + '%');
                    //$('#phanTramTheTinDung').append(creditCardPercentage.toFixed(2) + '%');

                    //$('#tienMatPB').css('width', cashPercentage.toFixed(2) + '%');
                    //$('#theThanhVienPB').css('width', userCardPercentage.toFixed(2) + '%');
                    //$('#theTinDungPB').css('width', creditCardPercentage.toFixed(2) + '%');

                    //Tổng thu chart
                    if (dataPayment.totalPaymentList.length > 1) {
                        //$('#tongThuChart').show();
                        //$('#lineChart').remove();
                        //$('#tongThuChart').append('<canvas id="lineChart" style="width:100%;height:300px"></canvas>');
                        tongThuChart(dataPayment);
                    } else {
                        $('#tongThuChart').hide();
                    }
                } else {
                    ShowMessage("Thao tác không thành công. Vui lòng thử lại sau.", 1);
                }
            }
        });

        function tongHoaDonChart(dataBill) {
            var pieChartCanvas = $("#pieChart").get(0).getContext("2d");
            var pieChart = new Chart(pieChartCanvas);
            var PieData = [
              {
                  value: dataBill.totalBillAtStore,
                  color: "#f56954",
                  highlight: "#f56954",
                  label: "AtStore"
              },
              {
                  value: dataBill.totalBillTakeAway,
                  color: "#00a65a",
                  highlight: "#00a65a",
                  label: "TakeAway"
              },
              {
                  value: dataBill.totalBillDelivery,
                  color: "#f39c12",
                  highlight: "#f39c12",
                  label: "Delivery"
              },
            ];
            var pieOptions = {
                //Boolean - Whether we should show a stroke on each segment
                segmentShowStroke: true,
                //String - The colour of each segment stroke
                segmentStrokeColor: "#fff",
                //Number - The width of each segment stroke
                segmentStrokeWidth: 2,
                //Number - The percentage of the chart that we cut out of the middle
                percentageInnerCutout: 60, // This is 0 for Pie charts
                //Number - Amount of animation steps
                animationSteps: 100,
                //String - Animation easing effect
                animationEasing: "easeOutBounce",
                //Boolean - Whether we animate the rotation of the Doughnut
                animateRotate: true,
                //Boolean - Whether we animate scaling the Doughnut from the centre
                animateScale: false,
                //Boolean - whether to make the chart responsive to window resizing
                responsive: true,
                // Boolean - whether to maintain the starting aspect ratio or not when responsive, if set to false, will take up entire container
                maintainAspectRatio: true,
                //String - A legend template
                legendTemplate: "<ul class=\"<%=name.toLowerCase()%>-legend\"><% for (var i=0; i<segments.length; i++){%><li><span style=\"background-color:<%=segments[i].fillColor%>\"></span><%if(segments[i].label){%><%=segments[i].label%><%}%></li><%}%></ul>"
            };
            //Create pie or douhnut chart
            // You can switch between pie and douhnut using the method below.
            pieChart.Doughnut(PieData, pieOptions);
        };

        function tongThuChart(dataPayment) {
            var lineChartCanvas = $("#lineChart").get(0).getContext("2d");
            var lineChart = new Chart(lineChartCanvas);

            Chart.defaults.global.scaleLabel = function (label) {
                //return label.value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
                return numberWithDot(label.value);
            };

            Chart.defaults.global.tooltipTemplate = function (label) {
                //return label.datasetLabel + ': ' + label.value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
                //return label.value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
                return numberWithDot(label.value);
            };

            var lineData = {
                //labels: ["January", "February", "March", "April", "May", "June", "July"],
                labels: dataPayment.dateList,
                datasets: [
                    {
                        label: "My First dataset",
                        fillColor: "rgba(151,187,205,0.2)",
                        strokeColor: "rgba(151,187,205,1)",
                        pointColor: "rgba(151,187,205,1)",
                        pointStrokeColor: "#fff",
                        pointHighlightFill: "#fff",
                        pointHighlightStroke: "rgba(151,187,205,1)",
                        data: dataPayment.totalPaymentList
                    }
                ]
            };
            var lineOption = {
                ///Boolean - Whether grid lines are shown across the chart
                scaleShowGridLines: true,

                //String - Colour of the grid lines
                scaleGridLineColor: "rgba(0,0,0,.05)",

                //Number - Width of the grid lines
                scaleGridLineWidth: 1,

                //Boolean - Whether to show horizontal lines (except X axis)
                scaleShowHorizontalLines: true,

                //Boolean - Whether to show vertical lines (except Y axis)
                scaleShowVerticalLines: true,

                //Boolean - Whether the line is curved between points
                bezierCurve: true,

                //Number - Tension of the bezier curve between points
                bezierCurveTension: 0.4,

                //Boolean - Whether to show a dot for each point
                pointDot: true,

                //Number - Radius of each point dot in pixels
                pointDotRadius: 4,

                //Number - Pixel width of point dot stroke
                pointDotStrokeWidth: 1,

                //Number - amount extra to add to the radius to cater for hit detection outside the drawn point
                pointHitDetectionRadius: 20,

                //Boolean - Whether to show a stroke for datasets
                datasetStroke: true,

                //Number - Pixel width of dataset stroke
                datasetStrokeWidth: 2,

                //Boolean - Whether to fill the dataset with a colour
                datasetFill: true,

                //String - A legend template
                legendTemplate: "<ul class=\"<%=name.toLowerCase()%>-legend\"><% for (var i=0; i<datasets.length; i++){%><li><span style=\"background-color:<%=datasets[i].strokeColor%>\"></span><%if(datasets[i].label){%><%=datasets[i].label%><%}%></li><%}%></ul>"
            };

            lineChart.Line(lineData, lineOption)
        };

        $(function () {
            function cb(start, end, label) {
                if (label != "Tùy chọn") {
                    $('#date-string').val(label);
                } else if (start.format('DD/MM/YYYY') == end.format('DD/MM/YYYY')) {
                    $('#date-string').val(start.format('DD/MM/YYYY'));
                } else {
                    $('#date-string').val(start.format('DD/MM/YYYY') + ' - ' + end.format('DD/MM/YYYY'));
                }
                $('#startDate').val(start.format('DD/MM/YYYY'));
                $('#endDate').val(end.format('DD/MM/YYYY'));
            }
            cb(moment(), moment(), 'Hôm nay');

            $('#reportrange').daterangepicker({
                "opens": "left",
                locale: {
                    format: 'DD/MM/YYYY'
                },
                ranges: {
                    'Hôm nay': [moment(), moment()],
                    'Hôm qua': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
                    'Tuần này': [moment().startOf('isoweek'), moment().endOf('isoweek')],
                    'Tuần trước': [moment().subtract(1, 'week').startOf('isoweek'), moment().subtract(1, 'week').endOf('isoweek')],
                    'Tháng này': [moment().startOf('month'), moment().endOf('month')],
                    'Tháng trước': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
                }
            }, cb);

            //$('#datetimepicker10').datetimepicker({
            //    viewMode: 'months',
            //    format: 'MM/YYYY'
            //});

            if ($('#date-string').val().toString().indexOf('/') > 0) {
                $('#date').append('Tổng quan ngày ' + $('#date-string').val());
            } else {
                $('#date').append('Tổng quan ' + $('#date-string').val().toString().toLowerCase());
            }
            $('#tongThuChart').hide();
            $('#avgTotalAmount').hide();
            $('#avgTotalDiscount').hide();
            $('#avgFinalAmount').hide();
            getData($('#startDate').val(), $('#endDate').val());
        });
    }
</script>
